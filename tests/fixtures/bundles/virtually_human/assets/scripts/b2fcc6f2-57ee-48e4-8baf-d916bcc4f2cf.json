{
  "type": "script",
  "uuid": "b2fcc6f2-57ee-48e4-8baf-d916bcc4f2cf",
  "name": "b2fcc6f2-57ee-48e4-8baf-d916bcc4f2cf_script",
  "description": "",
  "source": "// THIS IS THE CONDITIONAL TOKEN - ONLY USE IF THERE IS A PREREQUISITE TO GATHERING\n\nstring pCoinValue       = \"10\";                              // Change the number to make it worth more or less\nstring pPenalty         = \"-10\";   \ninteger vhTokenRotate   = FALSE;\nstring CONTROLLER_ID    = \"A\";    \nfloat tAlpha = 0.8;    // set this to 1.0 if you want your object to be fully opaque.                              // Make it a negative number. \n                                                                //How many points does it cost to fail this condition?\nstring pAcquireMessage  = \"You got tokens!\";     // change the text inside quotes to make it say something different\nstring pAcqFailMessage  = \"Ouch! You lost tokens.\";           \nstring pTYPE            = \"UNDEFINED\";  \n\nstring  gsCardOneName = \"config\";\nlist    gOneCard;\nlist    g_lTempLines;\nstring  g_sNoteCardName;\ninteger g_iLine;\nstring  g_kQuery;\ninteger resetChannel = 3;\ninteger respawnDelay = 30;\nstring  vhUseParticles = \"TRUE\";\nfloat  vhTargetOmega = 0.3;\ninteger dialog_channel2;\n                                 \n\n// Potential conditions (TYPES) - Choose the type name from the menu indicate which TYPE of condition must be met.\n//\n//     TYPE         MEANING (n represents any number)\n// PRIZE_COUNT: MUST HAVE n PRIZES\n// TOKEN_COUNT: MUST HAVE n TOKENS\n// PRIZE_NAME:  MUST HAVE <name> PRIZE\n// NOT_PRIZE:   MUST NOT HAVE <name> PRIZE\n// WEARING:     MUST WEAR <name> OBJECT\n// NOT_WEARING: MUST NOT WEAR <name> OBJECT\n\nstring  pParam = \"\";\nstring  pTokens = \"\";\nstring  pPrizes = \"\";\ninteger pValidated = -1;\ninteger pTokenSetFlag = -1;\nstring  pMes = \"\";\nstring  pToken = \"\";\ninteger lHandle1;\ninteger lHandle2;\ninteger lHandle3;\ninteger lHandle4;\ninteger lHandle5;\ninteger lHandle6;\ninteger lHandle7;\ninteger lHandle8;\ninteger vhAttachLoopFlag = 0;\nkey     pLastKeyClicker;\nstring  vhTimerState = \"default\";\n\n//----------------- PRIVATE -----------------------------\n\ninteger random_integer( integer min, integer max )\n{\n  return min + (integer)( llFrand( max - min + 1 ) );\n}\n\ninitialize(string _action) {\n    if (_action == \"\") {\n        //llSay(0, \"1\");\n        loadNoteCard(gsCardOneName);\n        //llSay(0, \"standby ... loading data\");\n    } else if (_action == \"finish\") {\n        //llSay(0, \"2\");\n        \n        integer i;\n        for (i = 0; i< 9; ++i)\n        {\n            string tLineText        = llList2String(gOneCard,i);\n            if (i == 0)\n            {\n                pCoinValue                = right(tLineText,\":\");\n            }\n            if (i == 1)\n            {\n                pAcquireMessage           = right(tLineText,\":\");\n            }\n            if (i == 2)\n            {\n                string tAlphaString       = right(tLineText,\":\");\n                tAlpha                    = (float)tAlphaString;\n            }\n            if (i == 3)\n            {\n                string stresetChannel      = right(tLineText, \":\");\n                resetChannel               = (integer)stresetChannel; \n                lHandle5 = llListen(resetChannel, \"\",\"\",\"\");  \n            }\n            if (i == 4)\n            {\n                string stRespawnDelay       = right(tLineText, \":\");\n                respawnDelay                = (integer)stRespawnDelay;\n                //llSay(0, stRespawnDelay);\n            }\n            if (i == 5)\n            {\n                vhUseParticles              = right(tLineText, \":\");\n                if (vhUseParticles == \"TRUE\")\n                    {\n                        llMessageLinked( LINK_SET, TRUE, CONTROLLER_ID, NULL_KEY );\n                    }else{\n                        llMessageLinked( LINK_SET, FALSE, CONTROLLER_ID, NULL_KEY );\n                    }\n            }\n            if (i == 6)\n            {\n                string stvhTargetOmega      = right(tLineText, \":\");\n                vhTargetOmega               = (float)stvhTargetOmega;\n                llTargetOmega(<0,0,vhTargetOmega>, 10, 10);\n            }\n            if (i == 7)\n            {\n                pAcqFailMessage = right(tLineText, \":\");   \n            }\n            if (i == 8)\n            {\n                pPenalty = right(tLineText, \":\");\n            }\n                            llSleep(1);\n                integer tRan = random_integer(4099, 4999);\n                dialog_channel2 = tRan;\n                llListenRemove(lHandle3);\n                lHandle3 = llListen(dialog_channel2,\"\", \"\",\"\");\n                \n        }\n    }\n}\n\nloadNoteCard( string _notecard ) {\n    g_lTempLines                    = [];\n    g_sNoteCardName                 = _notecard;\n    g_iLine                         = 0;\n    g_kQuery                        = llGetNotecardLine(g_sNoteCardName, g_iLine);\n}\n\nnotecardFinished(string _notecard){\n    if (_notecard == gsCardOneName) {\n        gOneCard                 = g_lTempLines;\n        initialize(\"finish\");\n    }\n}\n//--------------------------------------------\n\n\nvalidateCondition()\n{\n    {\n        llSay(1616, \"gimme\");\n        lHandle4 = llListen(1417,\"\",\"\",\"\");\n    }   \n}\n\nlastSub()\n{\n    if (pValidated == 1)\n    {\n        pMes = pAcquireMessage;\n        pToken = pCoinValue;\n        llSetAlpha(0.0, ALL_SIDES);\n        llMessageLinked( LINK_SET, FALSE, CONTROLLER_ID, NULL_KEY );\n        llSetLinkAlpha(LINK_SET, 0.0, ALL_SIDES);\n        llSetStatus(STATUS_ROTATE_Z, FALSE);\n        llSetStatus(STATUS_PHANTOM, TRUE);\n        llVolumeDetect(FALSE);\n        \n        if (respawnDelay > 0) \n        {\n         llSetTimerEvent(respawnDelay);\n        }\n        \n        llSay(1717, ((string) pLastKeyClicker + \":\" + pMes + \":\" + pToken));  \n        llMessageLinked( LINK_SET, FALSE, CONTROLLER_ID, NULL_KEY );\n        //llSay(0, \"line 60\");\n        //llSetTimerEvent(60);  \n           \n    } else {\n        if (pValidated == 0)\n        {\n        pMes = pAcqFailMessage;\n        pToken = pPenalty;\n        llSetAlpha(1.0, ALL_SIDES);\n        llMessageLinked( LINK_SET, TRUE, CONTROLLER_ID, NULL_KEY );\n        llSetLinkAlpha(LINK_SET, 1.0, ALL_SIDES);\n        llSetStatus(STATUS_ROTATE_Z, FALSE);\n        llSetStatus(STATUS_PHANTOM, TRUE);\n        llVolumeDetect(FALSE);\n        llSay(1717, ((string) pLastKeyClicker + \":\" + pMes + \":\" + pToken));  \n        //llSay(0, \"line 75\");\n        llSetTimerEvent(0);  \n        } \n    }\n    \n    \n    pValidated = -1;\n}\n\n\n// we need to gather the relevant comparator, then store it before the user encounters the token\nfinalValidation(integer tokenCount, integer prizeCount)\n{\n    if (pTYPE == \"PRIZE_COUNT\")\n        {\n         if (prizeCount >= (integer)pParam)\n         {\n             pValidated = 1;\n         }else{\n             pValidated = 0;\n         }\n         //llSay(0, \"Debug 83\");\n         lastSub();\n      }   \n        \n      if (pTYPE == \"TOKEN_COUNT\")\n      {\n          if (tokenCount >= (integer)pParam)\n          {\n              pValidated = 1;\n          }else{\n              pValidated = 0;\n          }\n          //llSay(0, \"Debug 95\");\n          lastSub();\n      }   \n        \n      if (pTYPE == \"PRIZE_NAME\" || pTYPE == \"NOT_PRIZE\")\n      {\n          \n          lHandle1 = llListen(3719, \"\", pLastKeyClicker, \"\");\n          llSay(1791, pParam);\n      } \n        \n     if (pTYPE == \"WEARING\" || pTYPE == \"NOT_WEARING\")\n     {\n         //if (vhAttachLoopFlag == 0) \n         //{\n         lHandle2 = llListen(3721, \"\", \"\", \"\");\n         llSay(3720, (string)pLastKeyClicker + \":\" + pParam);\n         vhTimerState = \"attachTimeout\";\n         //vhAttachLoopFlag = 1;\n         llSetTimerEvent(2);\n        //}\n    }        \n}\n\nstring left(string src, string divider) {\n    // a subroutine to get the text to the left of a given divider - in this case a colon\n    integer index = llSubStringIndex( src, divider );\n    if(~index)\n    {  \n        return llDeleteSubString( src, index + llStringLength(divider)-1, -1);\n    }\n    return src;\n}\n\n\nstring right(string src, string divider) {\n    integer index = llSubStringIndex( src, divider );\n    string tString = \"\";\n    if (~index) \n    {\n        return llDeleteSubString( src, 0, index + llStringLength(divider) - 1);\n    }\n    return tString;\n}\n\n\ndefault\n{\n    state_entry()\n    //\n    {\n        initialize(\"\"); \n        // on stateChange do stuff\n        integer lHandle5 = llListen(resetChannel, \"\",\"\",\"\");\n                llSetLinkAlpha(LINK_SET, tAlpha, ALL_SIDES);\n         // set entire prim 100% visible.\n        //llTargetOmega(<0,0,vhTargetOmega>, 10, 10); \n        llSetStatus(STATUS_PHANTOM, TRUE);\n        llSetStatus(STATUS_ROTATE_Z, TRUE);\n        llTargetOmega(<0,0,vhTargetOmega>, 10, 10);\n        llVolumeDetect(TRUE);\n        //lHandle3 = llListen(3717,\"\",\"\",\"\");\n        \n        \n    }\n    on_rez(integer start_param)\n    {\n        llSleep(1);\n        initialize(\"\");\n        llSleep(1);\n        pValidated = -1;\n        llSleep(1); \n    }\n    touch_start(integer total_number)\n    {\n        pLastKeyClicker = llDetectedKey(0);\n        if (pTokenSetFlag == -1) \n        {\n            if (llDetectedKey(0) == llGetOwner()) \n                {\n                    llDialog(llDetectedKey(0), \"Conditional Token:\\n\\n Which TYPE of token is this?\", [\"PRIZE_COUNT\", \"TOKEN_COUNT\", \"PRIZE_NAME\", \"NOT_PRIZE\", \"WEARING\", \"NOT_WEARING\"], dialog_channel2);\n                }  \n        }else{\n            float tAlpha = (llGetAlpha(ALL_SIDES/llGetNumberOfSides()));\n            if (tAlpha>0.0) \n            {\n                validateCondition();\n            }\n        }\n    }\n    \n    listen(integer channel, string name, key id, string mes)\n    {\n        if (channel == resetChannel)\n        {\n            pValidated = -1;\n            pTokenSetFlag = -1;\n            initialize(\"\");\n            llInstantMessage(pLastKeyClicker, \"Okay, I reset the token\");\n            llSetLinkAlpha(LINK_SET, 1.0, ALL_SIDES);\n            if (vhUseParticles == \"TRUE\")\n            {\n            llMessageLinked( LINK_SET, TRUE, CONTROLLER_ID, NULL_KEY );\n            }else{\n                llMessageLinked( LINK_SET, FALSE, CONTROLLER_ID, NULL_KEY );\n            }\n            llSetStatus(STATUS_PHANTOM, TRUE);\n            llVolumeDetect(TRUE);\n        }\n        if (channel == dialog_channel2) {\n            llListenRemove(lHandle3);\n            \n            pTYPE = mes;\n            pTokenSetFlag = 1;\n\n            if (mes == \"PRIZE_COUNT\")\n            {\n                llInstantMessage(pLastKeyClicker, \"How many prizes are required to obtain this token?\");\n                lHandle6 = llListen(0,\"\", id,\"\"); // listen to chat for a message from the caller    \n            }\n            if (mes == \"TOKEN_COUNT\")\n            {\n                llInstantMessage(pLastKeyClicker, \"How many tokens are required to obtain this token?\");\n                lHandle6 = llListen(0,\"\", id,\"\"); // listen to chat for a message from the caller \n            }\n            if (mes == \"PRIZE_NAME\" || mes == \"NOT_PRIZE\")\n            {\n                llInstantMessage(pLastKeyClicker, \"Please click on the PUZZLE BOARD that will award the Prize you want to require or exclude. You must be within 20 meters of the puzzle board.\");\n                lHandle7 = llListen(3731,\"\", \"\",\"\"); \n            }          \n            if (mes == \"WEARING\" || mes == \"NOT_WEARING\")\n            {\n                llInstantMessage(pLastKeyClicker, \"What is the EXACT name of the object / attachment?\");\n                llListen(0,\"\", id,\"\"); // listen to chat for a message from the caller \n                //lHandle8 = llListen(3721,\"\", \"\",\"\"); \n            }\n        }\n        //\n        if (channel == 0) {\n            llListenRemove(lHandle6);\n            pParam = mes;\n        }\n        \n        if (channel == 1417)\n            {\n                llListenRemove(lHandle4);\n                llSleep(1);\n                    pTokens = left(mes, \":\");\n                    pPrizes = right(mes, \":\");\n                    finalValidation((integer)pTokens, (integer)pPrizes);\n        }\n        if (channel == 3719) {\n            llListenRemove(lHandle1);\n            if (pTYPE == \"PRIZE_NAME\") {\n                if (mes == \"-1\") {\n                    pValidated = 0;\n                }else{\n                    pValidated = 1;\n                }   \n            }else{\n                if (mes == \"-1\") {\n                    pValidated = 1;\n                }else{\n                    pValidated = 0;\n                }\n            }\n            //\n            //llSay(0, \"Debug 240\");\n            lastSub();\n        }\n        if (channel == 3721) \n        \n        {\n            llListenRemove(lHandle2);\n             string incLeft = left(mes, \":\");\n             string incRight = right(mes, \":\");\n             if ((key)incLeft == pLastKeyClicker)\n             {\n            if (pTYPE == \"WEARING\") {\n                if (incRight == \"-1\") {\n                    pValidated = 0;\n                }else{\n                    pValidated = 1;\n                }\n            }else{ \n            //llSay(0, incRight);\n            // pTYPE = NOT WORN\n                if (incRight == \"-1\") {\n                    pValidated = 1;\n                }else{\n                    pValidated = 0;\n                }\n            }\n            //llSay(0, \"Debug 288\");\n            vhTimerState = \"default\";\n            llSetTimerEvent(0);\n            lastSub();\n        }\n        }\n        if (channel == 3731) {\n            llListenRemove(lHandle7);\n            pParam = mes;\n        }\n    }\n\n    collision_start(integer num_detected) \n    {\n        pLastKeyClicker = llDetectedKey(0);\n        float tAlpha = (llGetAlpha(ALL_SIDES/llGetNumberOfSides()));\n        if (tAlpha>0.0) \n        {\n            validateCondition();\n        }\n    }  \n    timer()\n        {\n            if (vhTimerState == \"default\") \n            {\n            llSetLinkAlpha(LINK_SET, tAlpha, ALL_SIDES);\n            if (vhUseParticles == \"TRUE\")\n            {\n            llMessageLinked( LINK_SET, TRUE, CONTROLLER_ID, NULL_KEY );\n            }else{\n                llMessageLinked( LINK_SET, FALSE, CONTROLLER_ID, NULL_KEY );\n            }\n            llVolumeDetect(TRUE);\n            llSetStatus(STATUS_PHANTOM, TRUE);\n            llSleep(1);\n            llSetTimerEvent(0);  \n            \n            }\n            if (vhTimerState == \"attachTimeout\")\n            {\n                vhTimerState = \"default\";\n                llSetLinkAlpha(LINK_SET, 1.0, ALL_SIDES);\n                llMessageLinked( LINK_SET, TRUE, CONTROLLER_ID, NULL_KEY );\n                if (pTYPE == \"WEARING\") \n                {\n                    // They are not wearing and should be\n                    pValidated = 0;\n                    //llSay(0, \"Debug 324\");\n                    lastSub();\n                    llSetTimerEvent(respawnDelay);\n                    \n                }else{\n                    //pTYPE = NOT WEARING\n                    // They are not wearing and should not be\n                    pValidated = 1;\n                    //llSay(0, \"Debug 332\");\n                    lastSub();\n                    llSetTimerEvent(respawnDelay);\n                }\n            } \n        }\n        \n            dataserver(key _query_id, string _data)\n    {\n        if (_query_id == g_kQuery) {\n            if (_data != EOF) {\n                g_lTempLines += [_data];\n                g_iLine++;\n                g_kQuery = llGetNotecardLine(g_sNoteCardName, g_iLine);\n            } else {\n                    notecardFinished(g_sNoteCardName);\n            }\n        }\n    }\n    \n}\n",
  "creator": {
    "name": "",
    "uuid": "",
    "grid": ""
  },
  "permissions": {},
  "object_name": ""
}